<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Study Engine - Enterprise v6.6 (Timer & Pause)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.mjs" type="module"></script>
    <script>pdfjsLib = window['pdfjs-dist/build/pdf'];</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- üé® Memrizz Inspired Core Styles (High Contrast, Clean, Card-Focused) --- */
        :root {
            --primary: #5856D6; /* Deep Purple/Violet - Primary App Store Color */
            --primary-light: #7B79FF;
            --secondary: #34C759; /* Green for Success/Action */
            --error: #FF3B30;
            --bg-dark: #1C1C1E; /* Deep Dark Mode Background */
            --bg-medium: #2C2C2E; /* Card/Panel Background */
            --bg-light: #3A3A3C; /* Input/Accent Background */
            --text-main: #FFFFFF;
            --text-sub: #EBEBF599; /* Light Grey Subtext */
            --radius-xl: 14px; /* Large rounded corners for cards */
            --radius-md: 8px;
            --shadow-elevation: 0 4px 12px rgba(0, 0, 0, 0.5);
            --header-height: 60px;
        }

        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: all 0.2s ease-out;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align top for better mobile view */
        }
        
        .app-container {
            width: 100%;
            max-width: 900px;
            padding: calc(var(--header-height) + 20px) 20px 20px;
            margin: auto;
        }
        .hidden { display: none !important; }
        .hidden-view { display: none !important; }

        /* --- Navigation & Headers --- */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            padding: 0 20px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-dark);
            border-bottom: 1px solid var(--bg-medium);
        }
        .brand { font-size: 1.6rem; font-weight: 700; color: var(--primary-light); }
        .user-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            background: var(--bg-medium);
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .user-pill img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        
        /* --- Card and Input Styling --- */
        .card {
            background-color: var(--bg-medium);
            border-radius: var(--radius-xl);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-elevation);
        }
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .step-num {
            background: var(--primary);
            color: var(--text-main);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 700;
        }
        
        label {
            display: block;
            font-size: 0.9rem;
            color: var(--text-sub);
            margin-bottom: 5px;
            margin-top: 15px;
        }
        
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-light);
            color: var(--text-main);
            border: 1px solid var(--bg-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            box-shadow: none;
            -webkit-appearance: none;
        }

        .upload-area {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px dashed var(--primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            background-color: rgba(88, 86, 214, 0.1);
        }
        .upload-area:hover { background-color: rgba(88, 86, 214, 0.2); }
        .upload-info strong { display: block; font-size: 1rem; }
        .upload-info span { font-size: 0.8rem; color: var(--text-sub); }
        .icon-circle { 
            width: 40px; height: 40px; border-radius: 50%; 
            background: var(--primary); display: flex; align-items: center; 
            justify-content: center; font-size: 1.2rem;
        }

        /* --- Buttons --- */
        .action-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 10px;
            color: var(--text-main);
            background: var(--primary);
            box-shadow: 0 4px 8px rgba(88, 86, 214, 0.4);
        }
        .action-btn.secondary {
            background: var(--bg-light);
            color: var(--primary-light);
            box-shadow: none;
            border: 1px solid var(--primary);
        }
        .action-btn.danger { background: var(--error); box-shadow: 0 4px 8px rgba(255, 59, 48, 0.4); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .clear-btn {
            background: none;
            border: none;
            color: var(--error);
            font-size: 0.9rem;
            margin-top: 10px;
            cursor: pointer;
            text-align: right;
            width: 100%;
            padding: 5px 0;
        }

        /* --- Loading & Status --- */
        .loading-area { 
            text-align: center; 
            margin-top: 20px;
            padding: 15px;
            background: var(--bg-dark);
            border-radius: var(--radius-md);
        }
        .status-message {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-sub);
        }

        /* --- Quiz Specifics (Memrizz Look) --- */
        .quiz-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--bg-light);
            padding-bottom: 15px;
            position: relative;
        }

        .timer-display {
            position: absolute;
            top: -5px;
            right: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--secondary);
            background: var(--bg-dark);
            padding: 3px 8px;
            border-radius: var(--radius-md);
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-sub);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
        }
        .icon-btn:hover { color: var(--text-main); }
        
        .progress-track {
            flex-grow: 1;
            height: 8px;
            background: var(--bg-light);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
        }
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-btn {
            background: var(--bg-light);
            color: var(--text-main);
            padding: 18px;
            border: none;
            border-radius: var(--radius-md);
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .option-btn:hover:not([disabled]) { background: var(--bg-medium); }
        .option-btn.correct { background: var(--secondary); color: var(--bg-dark); font-weight: 700; }
        .option-btn.wrong { background: var(--error); color: var(--text-main); opacity: 0.7; }

        #quiz-image {
            max-width: 100%;
            height: auto;
            max-height: 200px; 
            object-fit: contain;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            border: 2px solid var(--primary);
        }
        
        .feedback-box {
            padding: 15px;
            margin-top: 20px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.95rem;
            line-height: 1.4;
        }

        /* --- Modal and Summary --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bg-medium);
            padding: 30px;
            border-radius: var(--radius-xl);
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: var(--shadow-elevation);
        }
        .modal-content h1 { color: var(--primary-light); margin-bottom: 10px; }
        
        /* Retaining custom avatar for stability */
        .avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary-light);
            display: inline-block;
        }

        /* --- Toast Notification (Updated Style) --- */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--bg-medium);
            color: var(--text-main);
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            font-size: 0.9rem;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.error { background-color: var(--error); }
        .toast.success { background-color: var(--secondary); color: var(--bg-dark); }

        /* --- Pause Overlay --- */
        #pause-modal {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
        }
        #pause-modal .modal-content {
            background: var(--bg-dark);
            border: 2px solid var(--primary);
        }
        #pause-modal .modal-content h1 { color: var(--text-main); }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .app-container { padding: calc(var(--header-height) + 15px) 15px 15px; }
            .card { padding: 15px; }
            .upload-area { flex-direction: column; text-align: center; }
            .quiz-header { flex-wrap: wrap; }
            #question-jump-select { order: 3; flex-basis: 100%; margin-top: 10px; }
            .timer-display { position: static; margin-top: 10px; width: 100%; text-align: center; }
        }
        
    </style>
    
</head>
<body>
    <div class="glow-orb orb-1"></div>
    <div class="glow-orb orb-2"></div>

    <header class="app-header">
        <div class="brand">Lumina<i class="fas fa-brain" style="font-size: 1.2rem; margin-left: 5px; color: var(--primary);"></i></div>
        <div class="user-pill" onclick="Controller.toggleSettings()">
            <div class="avatar"></div>
            <span id="nav-username">Student</span>
        </div>
    </header>

    <div class="app-container">
        
        <div id="view-hub">
            <div class="card">
                <div class="card-title"><div class="step-num">1</div><h2>Source & Topic</h2></div>
                <label for="topic-input">Learning Topic</label>
                <input type="text" id="topic-input" placeholder="e.g., Home Safety, Roman Empire">

                <label for="file-upload" style="margin-top: 15px;">PDF File (Max 100+ Pages)</label>
                <div id="drop-zone" class="upload-area">
                    <div class="icon-circle"><i class="fas fa-file-pdf"></i></div>
                    <div class="upload-info">
                        <strong id="file-name">Select PDF Source</strong>
                        <span>Tap to upload or drop file</span>
                    </div>
                    <input type="file" id="file-upload" accept="application/pdf" class="hidden">
                </div>
                <button id="clear-source-btn" class="clear-btn"><i class="fas fa-trash-alt"></i> Clear Input</button>
            </div>

            <div class="card">
                <div class="card-title"><div class="step-num" style="background: var(--secondary);">2</div><h2>Study Configuration</h2></div>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1 1 150px;">
                        <label for="quiz-length-select">Questions/Session</label>
                        <select id="quiz-length-select">
                            <option value="5">5 Questions</option>
                            <option value="10">10 Questions</option>
                            <option value="25">25 Questions</option>
                            <option value="50">50 Questions</option>
                            <option value="100">100 Questions (Max)</option>
                        </select>
                    </div>
                    
                    <div style="flex: 1 1 150px;">
                        <label>Study Mode</label>
                        <div class="mode-radios" style="display: flex; flex-direction: column; gap: 5px; padding-top: 12px;">
                            <label style="font-size: 0.9rem; color: var(--text-main);">
                                <input type="radio" name="study-mode" value="quiz" checked> Quiz
                            </label>
                            <label style="font-size: 0.9rem; color: var(--text-main);">
                                <input type="radio" name="study-mode" value="flashcard"> Flashcards
                            </label>
                            <label style="font-size: 0.9rem; color: var(--text-main);">
                                <input type="radio" name="study-mode" value="worksheet"> Worksheet
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <button id="generate-btn" class="action-btn">Build Library (100 Qs)</button>

            <div id="loading-area" class="loading-area hidden">
                <div class="progress-track" style="height: 10px;">
                    <div id="ai-loader-bar" class="progress-fill" style="width: 0%;"></div>
                </div>
                <div id="system-status" class="status-message">Awaiting input...</div>
            </div>

        </div>
        
        <div id="view-quiz" class="hidden-view">
            <div class="card">
                <div class="quiz-header">
                    <button class="icon-btn" onclick="Controller.pauseSession()"><i class="fas fa-pause"></i> Pause</button>
                    <div class="progress-track">
                        <div id="quiz-progress-bar" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <span id="question-tracker">0/5</span>
                    <select id="question-jump-select" onchange="Controller.jumpToQuestion(this)"></select>
                    <span id="quiz-timer" class="timer-display">00:00</span>
                </div>
                
                <img id="quiz-image" src="" alt="Visual Aid for Quiz Question" class="hidden">

                <p id="q-text" style="font-size: 1.2rem; font-weight: 600; margin-bottom: 20px;">Question text will appear here.</p>

                <div id="options-container" class="options-list">
                    </div>

                <div id="q-feedback" class="feedback-box hidden">
                    </div>

                <button id="next-q-btn" class="action-btn hidden">Continue</button>
            </div>
        </div>

        <div id="view-flashcards" class="hidden-view">
            <div class="card">
                <div class="quiz-header">
                    <button class="icon-btn" onclick="Controller.pauseSession()"><i class="fas fa-pause"></i> Pause</button>
                    <div class="progress-track">
                        <div id="flashcard-progress-bar" class="progress-fill" style="width: 0%;"></div>
                    </div>
                    <span id="flashcard-tracker">0/5</span>
                    <span id="flashcard-timer" class="timer-display">00:00</span>
                </div>
                
                <style>
                    .flashcard-container { perspective: 1000px; height: 300px; margin-bottom: 20px; }
                    .flashcard-container-inner {
                        position: relative; width: 100%; height: 100%; transition: transform 0.8s;
                        transform-style: preserve-3d; cursor: pointer;
                    }
                    .flashcard-container-inner.flipped { transform: rotateY(180deg); }
                    .flashcard-face {
                        position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
                        background: var(--bg-light); border-radius: var(--radius-xl); padding: 25px;
                        display: flex; flex-direction: column; justify-content: center; align-items: center;
                        box-shadow: var(--shadow-elevation);
                    }
                    .flashcard-front { transform: rotateY(0deg); }
                    .flashcard-back { transform: rotateY(180deg); text-align: left; }
                    .flashcard-image { margin: 10px 0; max-height: 150px; border-radius: var(--radius-md); }
                </style>
                
                <div id="flashcard-container" class="flashcard-container">
                    <div class="flashcard-container-inner" onclick="Controller.flipCard(this)">
                        <div class="flashcard-face flashcard-front">
                            <div id="flashcard-front-content" style="font-size: 1.2rem; font-weight: 600; text-align: center;">Question text (Tap to Flip)</div>
                        </div>
                        <div class="flashcard-face flashcard-back">
                            <div id="flashcard-back-content">Answer and explanation appear here.</div>
                        </div>
                    </div>
                </div>
                
                <button id="flashcard-next-btn" class="action-btn" onclick="Controller.nextCard()">Next Card</button>
            </div>
        </div>

        <div id="view-worksheet" class="hidden-view" style="margin-bottom: 20px;">
            <div class="worksheet-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 1.5rem; color: var(--primary-light);">Printable Practice Sheet</h2>
                <button class="icon-btn" onclick="Controller.closeWorksheet()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="worksheet-content-wrapper card" style="padding: 30px;">
                <div id="worksheet-content">
                    </div>
                
                <div id="worksheet-answer-key" class="hidden-print" style="padding: 15px 0; margin-top: 20px; border-top: 1px solid var(--bg-light);">
                    <div id="worksheet-answer-key-content">
                        </div>
                </div>
            </div>
            
            <div class="worksheet-controls" style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="show-answer-key-btn" class="action-btn secondary" onclick="Controller.toggleWorksheetAnswerKey()" style="flex: 1;">Show Answer Key</button>
                <button class="action-btn" onclick="Controller.printWorksheet()" style="flex: 1;"><i class="fas fa-print"></i> Print Worksheet</button>
            </div>
        </div>
        

        <div id="quiz-summary-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h1>Review</h1>
                <p id="summary-score" style="font-size: 1.2rem; color: var(--text-sub);">Your Score: <strong class="primary-light" style="font-size: 1.5rem;">0/5</strong></p>
                <div class="summary-results-container" style="max-height: 200px; overflow-y: auto; margin: 15px 0;">
                    <div id="summary-results-list" style="text-align: left; padding: 10px; font-size: 0.9rem;">
                        </div>
                </div>
                <button class="action-btn secondary" onclick="Controller.retakeQuiz()">Retake Quiz</button>
                <button class="action-btn" onclick="Controller.closeSummary()">Back to Hub</button>
            </div>
        </div>

        <div id="settings-modal" class="modal-overlay hidden" onclick="if(event.target.id === 'settings-modal') Controller.toggleSettings()">
            <div class="modal-content">
                <h1>Settings</h1>
                
                <div class="input-wrapper" style="text-align: left;">
                    <label for="username-input">Student Name</label>
                    <input type="text" id="username-input" placeholder="Enter your name">
                </div>

                <div class="input-wrapper" style="text-align: left;">
                    <label for="age-slider">Learning Level (Age: <span id="level-badge">12 yrs ‚Ä¢ Creator</span>)</label>
                    <input type="range" id="age-slider" min="6" max="18" step="1" style="width: 100%;">
                </div>

                <button class="action-btn danger" onclick="Controller.resetApp()">Factory Reset App</button>
                <button class="action-btn secondary" onclick="Controller.toggleSettings()">Save & Close</button>
            </div>
        </div>

        <div id="pause-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <i class="fas fa-pause-circle" style="font-size: 3rem; color: var(--primary-light); margin-bottom: 10px;"></i>
                <h1>Session Paused</h1>
                <p style="font-size: 1rem; color: var(--text-sub); margin-bottom: 20px;">Your progress and time are saved.</p>
                <button class="action-btn" onclick="Controller.resumeSession()"><i class="fas fa-play"></i> Resume</button>
                <button class="action-btn secondary" onclick="Controller.showSummaryAndExit()"><i class="fas fa-sign-out-alt"></i> Exit & Review</button>
            </div>
        </div>
        
        <div id="toast-message" class="toast hidden"></div>

    </div>

<script>
    // --- V6.6 CONFIGURATION ---
    const CONFIG = {
        MIN_PAGES_TO_PROCESS: 100,
        MAX_QUESTIONS_GENERATED: 100,
        MAX_INFERENCE_RETRIES: 3,
        TIMER_INTERVAL_MS: 1000, 
    };

    // SIMULATED EXTERNAL ASSET MANIFEST (Pexels URLs)
    const SIMULATED_PEXELS_URLS = [
        "https://images.pexels.com/photos/164005/pexels-photo-164005.jpeg?auto=compress&cs=tinysrgb&w=800", // Fire extinguisher
        "https://images.pexels.com/photos/209807/pexels-photo-209807.jpeg?auto=compress&cs=tinysrgb&w=800", // Water Leak
        "https://images.pexels.com/photos/1036329/pexels-photo-1036329.jpeg?auto=compress&cs=tinysrgb&w=800", // Emergency Kit
        "https://images.pexels.com/photos/1486222/pexels-photo-1486222.jpeg?auto=compress&cs=tinysrgb&w=800", // First Aid Kit
        "https://images.pexels.com/photos/110820/pexels-photo-110820.jpeg?auto=compress&cs=tinysrgb&w=800" // Smoke Alarm
    ];


    // --- GLOBAL STATE ---
    const State = {
        allQuestions: [],
        sessionQuestions: [],
        currentQIndex: 0,
        quizResults: [], // Stores { q: ..., correct: ..., selected: ..., answer: ..., time: [seconds] }
        imageManifest: {}, 
        settings: {
            username: localStorage.getItem("lumina_user") || "Student",
            age: parseInt(localStorage.getItem("lumina_age")) || 12
        },
        lastFile: null, 
        studyMode: 'quiz',
        quizLength: 5,
        isPaused: false,
        sessionStartTime: 0,
        sessionElapsedTime: 0,
        questionStartTime: 0,
        currentView: 'view-hub'
    };

    // --- UI MAPPING (Refactored) ---
    const UI = {
        btn: document.getElementById('generate-btn'),
        loadingArea: document.getElementById('loading-area'), 
        status: document.getElementById('system-status'),
        loader: document.getElementById('ai-loader-bar'),
        fileInput: document.getElementById('file-upload'),
        topicInput: document.getElementById('topic-input'),
        dropZone: document.getElementById('drop-zone'),
        quizSummaryModal: document.getElementById('quiz-summary-modal'),
        toast: document.getElementById('toast-message'),
        clearBtn: document.getElementById('clear-source-btn'),
        qJumpSelect: document.getElementById('question-jump-select'),
        quizImage: document.getElementById('quiz-image'),
        quizLengthSelect: document.getElementById('quiz-length-select'),
        studyModeRadios: document.querySelectorAll('input[name="study-mode"]'),
        worksheetContent: document.getElementById('worksheet-content'),
        worksheetAnswerKeyContainer: document.getElementById('worksheet-answer-key'),
        worksheetShowKeyBtn: document.getElementById('show-answer-key-btn'),
        pauseModal: document.getElementById('pause-modal'),
        quizTimer: document.getElementById('quiz-timer'),
        flashcardTimer: document.getElementById('flashcard-timer')
    };

    // --- UTILITIES (Refactored) ---
    const Utils = {
        getImageUrl: (imageId) => State.imageManifest[imageId] || '', 

        aggressivelyCleanRawAIOutput: (rawStr) => {
            if (!rawStr) return "";
            let cleaned = rawStr.replace(/```json\s*/i, '').replace(/```\s*$/i, '').trim();
            let start = cleaned.indexOf('{');
            let end = cleaned.lastIndexOf('}');
            
            if (start === -1 || end === -1 || end <= start) {
                start = cleaned.indexOf('[');
                end = cleaned.lastIndexOf(']');
                if (start === -1 || end === -1 || end <= start) {
                    return ""; 
                }
            }
            return cleaned.substring(start, end + 1).replace(/,\s*([\]}])/g, '$1').trim();
        },

        safelyParseJSON: (rawStr) => {
            let jsonStr = Utils.aggressivelyCleanRawAIOutput(rawStr);
            if (!jsonStr || jsonStr.length < 5) {
                throw new Error("API output lacks valid JSON structure after cleanup.");
            }
            const questionSchema = (item) => typeof item === 'object' && item.q && Array.isArray(item.opts) && item.a && item.why && item.imageId; 
            try {
                const parsed = JSON.parse(jsonStr);
                if (typeof parsed === 'object' && Array.isArray(parsed.questions) && typeof parsed.imageManifest === 'object') {
                    if (parsed.questions.some(item => !questionSchema(item))) {
                        throw new Error("Parsed JSON array contains invalid question objects.");
                    }
                    return parsed;
                }
                throw new Error("Parsed JSON response is not the expected {questions, imageManifest} structure.");
            } catch (e) {
                throw new Error(`Syntax error in Enterprise-generated JSON: ${e.message}`);
            }
        },

        showToast: (message, type = 'info') => {
            let iconMap = { 'success': 'fas fa-check-circle', 'warning': 'fas fa-exclamation-triangle', 'error': 'fas fa-exclamation-triangle', 'info': 'fas fa-info-circle' };
            UI.toast.innerHTML = `<i class="${iconMap[type]}"></i> ${message}`; 
            UI.toast.className = `toast ${type}`;
            UI.toast.classList.remove('hidden');
            setTimeout(() => { UI.toast.classList.add('hidden'); }, 3000); 
        },

        showCustomConfirm: (title, message, onConfirm, onCancel) => {
            const modal = UI.quizSummaryModal;
            modal.querySelector('h1').innerText = title;
            modal.querySelector('#summary-score').innerHTML = message;
            modal.querySelector('.summary-results-container').classList.add('hidden'); 

            const btn1 = modal.querySelector('.action-btn.secondary');
            btn1.innerText = "Cancel";
            btn1.onclick = () => { modal.classList.add('hidden'); if (onCancel) onCancel(); };

            const btn2 = modal.querySelector('.action-btn:not(.secondary)');
            btn2.innerText = title.includes("Reset") ? "Confirm Reset" : "Continue";
            btn2.onclick = () => { modal.classList.add('hidden'); onConfirm(); };
            
            modal.classList.remove('hidden');
        },

        shuffleArray: (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        formatTime: (totalSeconds) => {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(minutes)}:${pad(seconds)}`;
        }
    };
    
    // --- TIMER MODULE (New V6.6) ---
    const Timer = {
        intervalId: null,
        
        start: () => {
            State.isPaused = false;
            State.questionStartTime = Date.now();
            if (!Timer.intervalId) {
                Timer.intervalId = setInterval(Timer.update, CONFIG.TIMER_INTERVAL_MS);
            }
        },

        pause: () => {
            State.isPaused = true;
            if (Timer.intervalId) {
                clearInterval(Timer.intervalId);
                Timer.intervalId = null;
            }
        },

        stop: () => {
            Timer.pause();
            State.sessionElapsedTime = 0;
            Timer.updateUI(0);
        },

        update: () => {
            if (State.isPaused) return;

            State.sessionElapsedTime++;
            Timer.updateUI(State.sessionElapsedTime);
        },

        updateUI: (seconds) => {
            const formattedTime = Utils.formatTime(seconds);
            if (State.currentView === 'view-quiz') {
                UI.quizTimer.innerText = formattedTime;
            } else if (State.currentView === 'view-flashcards') {
                UI.flashcardTimer.innerText = formattedTime;
            }
        },
        
        // Captures time taken since questionStartTime, then resets questionStartTime
        captureQuestionTime: () => {
            if (State.isPaused) return 0;
            const timeTaken = Math.floor((Date.now() - State.questionStartTime) / 1000);
            State.questionStartTime = Date.now(); // Reset for next question/action
            return timeTaken;
        }
    };

    // --- CORE LOGIC (PDF & SIMULATED ENTERPRISE API) ---
    const Core = {
        // V6.5 FIX: Accepts callback for synchronous status updates
        extractTextFromPDF: async (file, onProgress) => {
            onProgress("Scanning PDF Structure...", 0);
            try {
                if (!window.pdfjsLib) throw new Error("PDF Engine not ready.");
                const buffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
                
                let fullText = "";
                const limit = pdf.numPages; 
                for (let i = 1; i <= limit; i++) {
                    onProgress(`Reading Page ${i} of ${limit}...`, (i / limit) * 50);
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const strings = content.items.map(item => item.str);
                    fullText += strings.join(" ") + " ";
                }
                
                if (fullText.trim().length < 500) { 
                     throw new Error("Extracted text is too short. Content is lacking.");
                }
                return fullText;
            } catch (e) {
                throw new Error("PDF Read Failed: " + e.message);
            }
        },

        // V6.5 FIX: Core function returns structured data
        callEnterpriseQuestionAPI: async (topic, text, onProgress, attempt = 1) => {
            onProgress(`Enterprise API processing context... (Attempt ${attempt}/${CONFIG.MAX_INFERENCE_RETRIES})`, 50);

            await new Promise(resolve => setTimeout(resolve, 3000)); 
            
            const mockQuestions = [];
            const mockManifest = {}; 
            const numQuestions = CONFIG.MAX_QUESTIONS_GENERATED;

            SIMULATED_PEXELS_URLS.forEach((url, index) => {
                const id = `asset-${index + 1}`;
                mockManifest[id] = url; 
            });

            for (let i = 1; i <= numQuestions; i++) {
                const imageId = `asset-${(i % SIMULATED_PEXELS_URLS.length) + 1}`;
                mockQuestions.push({
                    q: `Enterprise Q${i}: According to the visual aid for ${topic}, what is the primary function of the item shown?`, 
                    opts: [`A. Portable Radio`, `B. Battery Charger`, `C. First Aid Kit`, `D. Tarp`], 
                    a: `C. First Aid Kit`, 
                    why: `The First Aid Kit is a mandatory inclusion in every personal emergency evacuation kit. Visual context is provided by Asset ID: ${imageId}.`,
                    imageId: imageId 
                });
            }

            const rawResponse = JSON.stringify({
                questions: mockQuestions,
                imageManifest: mockManifest
            });

            try {
                const parsedResponse = Utils.safelyParseJSON(rawResponse);
                onProgress(`Successfully parsed ${parsedResponse.questions.length} questions.`, 100);
                return parsedResponse;
            } catch (e) {
                if (attempt < CONFIG.MAX_INFERENCE_RETRIES) {
                    onProgress(`API response parse failed. Retrying...`, 50);
                    await new Promise(resolve => setTimeout(resolve, 1500)); 
                    return Core.callEnterpriseQuestionAPI(topic, text, onProgress, attempt + 1);
                }
                throw new Error("API failed to return valid quiz questions after multiple retries.");
            }
        }
    };

    // --- APPLICATION CONTROLLER (V6.5 FIX: Centralized State Manager) ---
    const AppController = {
        
        // --- Initialization ---
        loadState: () => {
            State.lastFile = JSON.parse(localStorage.getItem("lumina_file")) || null;
            State.studyMode = localStorage.getItem("lumina_mode") || 'quiz';
            State.quizLength = parseInt(localStorage.getItem("lumina_length")) || 5; 
            
            const savedQuestions = sessionStorage.getItem('lumina_questions');
            if (savedQuestions) {
                try { State.allQuestions = JSON.parse(savedQuestions); } catch (e) { sessionStorage.removeItem('lumina_questions'); }
            }
            
            const savedManifest = sessionStorage.getItem('lumina_asset_manifest');
            if (savedManifest) {
                try { State.imageManifest = JSON.parse(savedManifest); } catch (e) { sessionStorage.removeItem('lumina_asset_manifest'); }
            }
        },

        initUI: () => {
            UI.quizLengthSelect.value = State.quizLength;
            document.querySelector(`input[name="study-mode"][value="${State.studyMode}"]`).checked = true;
            
            // Apply settings to UI
            document.getElementById('username-input').value = State.settings.username;
            document.getElementById('nav-username').innerText = State.settings.username;
            document.getElementById('age-slider').value = State.settings.age;
            AppController.updateLevelBadge(State.settings.age);

            UI.dropZone.onclick = () => UI.fileInput.click();
            UI.fileInput.onchange = AppController.handleFileSelect;
            UI.clearBtn.onclick = AppController.clearSource; 
            UI.quizLengthSelect.onchange = AppController.handleLengthChange;
            UI.studyModeRadios.forEach(radio => radio.onchange = AppController.handleModeChange);
            document.getElementById('age-slider').oninput = (e) => AppController.handleAgeChange(e.target.value);

            AppController.updateHubView();
        },

        updateHubView: () => {
             // Set button text and action based on state
            const mode = State.studyMode;
            const length = State.quizLength;
            
            if (State.allQuestions.length > 0) {
                const buttonText = (mode === 'worksheet') 
                    ? `Generate Worksheet (${length} Qs)`
                    : `Start ${mode.charAt(0).toUpperCase() + mode.slice(1)} (${length} Qs)`;
                UI.btn.innerText = buttonText;
                UI.btn.onclick = () => AppController.routeToStudyMode(State.studyMode);
            } else {
                UI.btn.innerText = `Build Library (${CONFIG.MAX_QUESTIONS_GENERATED} Qs)`;
                UI.btn.onclick = AppController.handleBuild;
            }

            // Update file display
            if (State.lastFile && State.lastFile.name) {
                document.getElementById('file-name').innerText = State.lastFile.name;
                UI.topicInput.value = State.lastFile.topic || '';
                UI.dropZone.classList.add('has-file');
                Utils.showToast(`Library ready. ${State.allQuestions.length} visual questions loaded.`, 'info');
            } else {
                document.getElementById('file-name').innerText = 'Select PDF Source';
                UI.topicInput.value = '';
                UI.dropZone.classList.remove('has-file');
            }
        },
        
        // --- Core Workflow ---
        handleBuild: async () => {
            const file = UI.fileInput.files[0];
            const topic = UI.topicInput.value.trim(); 

            if (!file) return Utils.showToast("Please select a PDF file.", 'warning');
            if (!topic) return Utils.showToast("Please enter a topic.", 'warning');
            
            // Check for force rebuild
            if (State.allQuestions.length > 0) {
                Utils.showToast(`Library loaded. Click 'Build' again within 5s to force rebuild.`, 'warning');
                if (!UI.btn.dataset.rebuildAttempt || (Date.now() - UI.btn.dataset.rebuildAttempt > 5000)) {
                    UI.btn.dataset.rebuildAttempt = Date.now();
                    return; 
                }
                State.allQuestions = []; sessionStorage.removeItem('lumina_questions');
                State.imageManifest = {}; sessionStorage.removeItem('lumina_asset_manifest');
            }
            UI.btn.dataset.rebuildAttempt = '';

            UI.btn.disabled = true;
            UI.loadingArea.classList.remove('hidden');

            const updateStatus = (msg, percent = null) => {
                UI.status.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${msg}`;
                if (percent !== null) UI.loader.style.width = `${percent}%`;
            };

            try {
                const text = await Core.extractTextFromPDF(file, updateStatus); 
                
                State.lastFile = { name: file.name, size: file.size, topic: topic }; 
                localStorage.setItem("lumina_file", JSON.stringify(State.lastFile));
                
                const response = await Core.callEnterpriseQuestionAPI(topic, text, updateStatus);
                
                State.allQuestions = response.questions;
                State.imageManifest = response.imageManifest;
                sessionStorage.setItem('lumina_questions', JSON.stringify(State.allQuestions));
                sessionStorage.setItem('lumina_asset_manifest', JSON.stringify(State.imageManifest));

                Utils.showToast(`Enterprise library built with ${State.allQuestions.length} questions!`, 'success');
                AppController.updateHubView();

            } catch (err) {
                UI.status.innerHTML = `<span style="color:var(--error)">‚ùå Error: ${err.message}</span>`;
                UI.loader.style.background = 'var(--error)';
                Utils.showToast(`Build Failed: ${err.message.substring(0, 80)}...`, 'error');
                AppController.updateHubView(); // Update view to re-enable button
            } finally {
                UI.btn.disabled = false;
                UI.loader.style.width = '100%'; 
                UI.loadingArea.classList.add('hidden');
            }
        },

        routeToStudyMode: (mode) => {
            if (State.allQuestions.length === 0) {
                Utils.showToast("Please build a library first.", 'warning');
                return;
            }

            const maxQs = State.allQuestions.length;
            const sessionLength = Math.min(State.quizLength, maxQs);
            
            State.sessionQuestions = Utils.shuffleArray([...State.allQuestions]).slice(0, sessionLength);
            State.currentQIndex = 0;
            State.quizResults = []; 
            State.sessionElapsedTime = 0; 
            
            // Centralized view switching
            document.querySelectorAll('.app-container > div').forEach(div => div.classList.add('hidden-view'));
            document.getElementById('view-hub').classList.add('hidden-view');

            State.currentView = `view-${mode}`;

            if (mode === 'quiz') {
                document.getElementById('view-quiz').classList.remove('hidden-view');
                AppController.startQuiz();
            } else if (mode === 'flashcard') {
                document.getElementById('view-flashcards').classList.remove('hidden-view');
                AppController.startFlashcards();
            } else if (mode === 'worksheet') {
                document.getElementById('view-worksheet').classList.remove('hidden-view');
                AppController.startWorksheet();
            }
        },

        exitStudyMode: () => {
            Timer.stop(); // Stop the session timer
            document.getElementById('view-quiz').classList.add('hidden-view');
            document.getElementById('view-flashcards').classList.add('hidden-view');
            document.getElementById('view-worksheet').classList.add('hidden-view');
            document.getElementById('view-hub').classList.remove('hidden-view');
            State.currentView = 'view-hub';
            AppController.updateHubView();
        },
        
        // --- Timer and Pause Controls (Defect LMNA-Q-500 Fix) ---
        pauseSession: () => {
            if (State.isPaused) return;
            Timer.pause();
            UI.pauseModal.classList.remove('hidden');
        },
        resumeSession: () => {
            UI.pauseModal.classList.add('hidden');
            Timer.start();
        },
        showSummaryAndExit: () => {
            UI.pauseModal.classList.add('hidden');
            if (State.studyMode === 'quiz') {
                AppController.showQuizSummary(true); 
            } else if (State.studyMode === 'flashcard') {
                AppController.exitFlashcards(); 
            }
        },

        // --- Event Handlers for Hub ---
        handleFileSelect: (e) => {
            const file = e.target.files[0];
            if(file) {
                State.lastFile = { name: file.name, topic: UI.topicInput.value.trim() }; 
                localStorage.setItem("lumina_file", JSON.stringify(State.lastFile));
                // Clear old library data to force rebuild on new file
                State.allQuestions = []; sessionStorage.removeItem('lumina_questions');
                State.imageManifest = {}; sessionStorage.removeItem('lumina_asset_manifest');
                AppController.updateHubView();
            }
        },
        clearSource: () => { 
            State.lastFile = null; State.allQuestions = []; State.sessionQuestions = []; State.imageManifest = {};
            localStorage.removeItem("lumina_file"); sessionStorage.clear();
            UI.fileInput.value = ''; UI.topicInput.value = '';
            AppController.updateHubView();
            Utils.showToast("Input and internal quiz data cleared.", 'info'); 
        },
        handleLengthChange: (e) => {
            State.quizLength = parseInt(e.target.value);
            localStorage.setItem("lumina_length", State.quizLength);
            AppController.updateHubView();
        },
        handleModeChange: (e) => {
            State.studyMode = e.target.value;
            localStorage.setItem("lumina_mode", State.studyMode);
            AppController.updateHubView();
        },
        
        // --- Settings & Reset ---
        handleAgeChange: (age) => {
            const val = parseInt(age);
            AppController.updateLevelBadge(val);
            State.settings.age = val;
            localStorage.setItem("lumina_age", val);
        },
        updateLevelBadge: (age) => {
             const role = age < 10 ? 'Explorer' : (age < 16 ? 'Creator' : 'Innovator');
             document.getElementById('level-badge').innerText = `${age} yrs ‚Ä¢ ${role}`;
        },
        toggleSettings: () => {
            const m = document.getElementById('settings-modal');
            m.classList.toggle('hidden');
            if(m.classList.contains('hidden')) {
                State.settings.username = document.getElementById('username-input').value;
                document.getElementById('nav-username').innerText = State.settings.username;
                localStorage.setItem("lumina_user", State.settings.username);
            }
        },
        resetApp: () => { 
            document.getElementById('settings-modal').classList.add('hidden');
            Utils.showCustomConfirm("Factory Reset", "Are you sure you want to delete all saved settings and cached data?", () => {
                localStorage.clear(); sessionStorage.clear(); location.reload(true); 
            }, () => {
                document.getElementById('settings-modal').classList.remove('hidden');
            });
        },


        // --- Quiz Mode Logic ---
        startQuiz: () => {
            Timer.start();
            UI.qJumpSelect.innerHTML = '';
            for(let i = 0; i < State.sessionQuestions.length; i++) {
                const option = document.createElement('option');
                option.value = i; option.innerText = `Q ${i + 1}`;
                UI.qJumpSelect.appendChild(option);
            }
            AppController.renderQuestion();
        },
        renderQuestion: () => {
            // Reset question timer on render
            Timer.captureQuestionTime(); 

            const q = State.sessionQuestions[State.currentQIndex];
            document.getElementById('question-tracker').innerText = `${State.currentQIndex + 1}/${State.sessionQuestions.length}`;
            document.getElementById('quiz-progress-bar').style.width = `${(State.currentQIndex / State.sessionQuestions.length) * 100}%`;
            document.getElementById('q-text').innerText = q.q;
            
            const imageUrl = Utils.getImageUrl(q.imageId);
            if (imageUrl) {
                UI.quizImage.src = imageUrl;
                UI.quizImage.classList.remove('hidden');
            } else {
                UI.quizImage.classList.add('hidden');
            }

            UI.qJumpSelect.value = State.currentQIndex;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            // Render options
            q.opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => AppController.checkAnswer(btn, opt, q); 
                container.appendChild(btn);
            });

            document.getElementById('q-feedback').classList.add('hidden');
            document.getElementById('next-q-btn').classList.add('hidden');
            document.getElementById('next-q-btn').innerText = (State.currentQIndex < State.sessionQuestions.length - 1) ? "Continue" : "Finish & Review";
            document.getElementById('next-q-btn').onclick = AppController.nextQuestion;
        },
        checkAnswer: (btn, selected, qData) => {
            // Capture time taken to answer
            const timeTaken = Timer.captureQuestionTime();
            Timer.pause(); // Pause timer while feedback is shown

            const buttons = document.querySelectorAll('#options-container .option-btn');
            buttons.forEach(b => b.disabled = true);

            const isCorrect = selected === qData.a;
            
            if (!State.quizResults[State.currentQIndex]) {
                State.quizResults[State.currentQIndex] = { 
                    q: qData.q, 
                    correct: isCorrect, 
                    selected: selected, 
                    answer: qData.a, 
                    time: timeTaken 
                };
            }

            if (isCorrect) {
                btn.classList.add('correct');
                Utils.showToast("Correct Answer!", 'success');
                AppController.showFeedback(true, `Correct! ${qData.why} (Time: ${timeTaken}s)`);
            } else {
                btn.classList.add('wrong');
                buttons.forEach(b => { if(b.innerText === qData.a) b.classList.add('correct'); });
                Utils.showToast("Incorrect Answer.", 'error');
                AppController.showFeedback(false, `Oops! ${qData.why} (Time: ${timeTaken}s)`);
            }
            document.getElementById('next-q-btn').classList.remove('hidden');
        },
        showFeedback: (isSuccess, msg) => {
            const fb = document.getElementById('q-feedback');
            fb.innerHTML = `<span style="font-size: 1.2em; margin-right: 5px;">${isSuccess ? '‚úÖ' : '‚ùå'}</span> ${msg}`;
            fb.classList.remove('hidden');
        },
        nextQuestion: () => {
            Timer.start(); // Resume timer for the next question
            if (State.currentQIndex < State.sessionQuestions.length - 1) {
                State.currentQIndex++;
                AppController.renderQuestion();
            } else {
                AppController.showQuizSummary(); 
            }
        },
        exitQuiz: AppController.exitStudyMode,
        jumpToQuestion: (selectElement) => {
            const index = parseInt(selectElement.value);
            if (!isNaN(index) && index >= 0 && index < State.sessionQuestions.length) {
                // Ensure the timer is reset if jumping to an unanswered question
                if (!State.quizResults[index]) {
                     Timer.captureQuestionTime(); 
                     Timer.start();
                } else {
                     Timer.pause(); 
                }
                State.currentQIndex = index;
                AppController.renderQuestion();
            }
        },
        showQuizSummary: (midExit = false) => {
            Timer.stop(); // Ensure timer is stopped upon finishing or exiting
            const modal = UI.quizSummaryModal;
            modal.querySelector('h1').innerText = midExit ? "Progress Review" : "Final Review";
            modal.querySelector('.summary-results-container').classList.remove('hidden'); 

            const totalAnswered = State.quizResults.filter(r => r).length;
            const correct = State.quizResults.filter(r => r && r.correct).length;
            const totalTime = Utils.formatTime(State.sessionElapsedTime);

            document.getElementById('summary-score').innerHTML = `
                Answered: <strong style="color: var(--primary-light);">${totalAnswered} / ${State.sessionQuestions.length}</strong><br>
                Score: <strong style="font-size: 1.5rem; color: var(--secondary);">${correct} / ${totalAnswered}</strong> (Time: ${totalTime})
            `;
            
            const list = document.getElementById('summary-results-list');
            list.innerHTML = '';

            State.sessionQuestions.forEach((q, index) => {
                const r = State.quizResults[index];
                const answered = r ? 'Answered' : 'Skipped';
                const status = r ? (r.correct ? 'Correct' : 'Wrong') : 'N/A';
                const time = r ? `${r.time}s` : 'N/A';

                list.innerHTML += `
                    <div style="margin-bottom: 8px; border-left: 3px solid ${r && r.correct ? 'var(--secondary)' : (r ? 'var(--error)' : 'var(--text-sub)')}; padding-left: 10px;">
                        <strong>Q${index + 1} (${status})</strong> - ${q.q}<br>
                        <span style="font-size: 0.8em; color: var(--text-sub);">
                            Your Answer: ${r ? r.selected : '‚Äî'} | Correct: ${q.a} | Time: ${time}
                        </span>
                    </div>
                `;
            });

            modal.classList.remove('hidden');
            modal.querySelector('.action-btn.secondary').innerText = "Retake Quiz";
            modal.querySelector('.action-btn:not(.secondary)').innerText = "Back to Hub";
        },
        closeSummary: () => { UI.quizSummaryModal.classList.add('hidden'); AppController.exitQuiz(); },
        retakeQuiz: () => { UI.quizSummaryModal.classList.add('hidden'); AppController.startQuiz(); },


        // --- Flashcard Mode Logic ---
        startFlashcards: () => {
            Timer.start();
            document.getElementById('flashcard-tracker').innerText = `1/${State.sessionQuestions.length}`;
            document.getElementById('flashcard-progress-bar').style.width = `0%`;
            AppController.renderFlashcard();
        },
        renderFlashcard: () => {
            // Reset question timer on render
            Timer.captureQuestionTime(); 
            
            const q = State.sessionQuestions[State.currentQIndex];
            document.getElementById('flashcard-tracker').innerText = `${State.currentQIndex + 1}/${State.sessionQuestions.length}`;
            document.getElementById('flashcard-progress-bar').style.width = `${(State.currentQIndex / State.sessionQuestions.length) * 100}%`;
            
            const cardContainerInner = document.querySelector('#flashcard-container .flashcard-container-inner');
            cardContainerInner.classList.remove('flipped');
            
            const frontContent = document.getElementById('flashcard-front-content');
            frontContent.innerHTML = q.q + " (Tap to Flip)";
            
            const imageUrl = Utils.getImageUrl(q.imageId);
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl; img.alt = "Visual Aid"; img.className = 'flashcard-image';
                frontContent.innerHTML = ''; // Clear text first
                frontContent.appendChild(img);
                frontContent.innerHTML += `<div style="margin-top: 10px;">${q.q} (Tap to Flip)</div>`;
            }

            document.getElementById('flashcard-back-content').innerHTML = `
                <h4>Correct Answer:</h4><p>${q.a}</p>
                <h4>Explanation (Source Excerpt):</h4><p>${q.why}</p>
            `;

            document.getElementById('flashcard-next-btn').innerText = (State.currentQIndex < State.sessionQuestions.length - 1) ? "Next Card" : "Finish & Back to Hub";
        },
        flipCard: (cardContainerInner) => { cardContainerInner.classList.toggle('flipped'); },
        nextCard: () => {
            Timer.start(); // Ensure timer continues/resumes on next card
            if (State.currentQIndex < State.sessionQuestions.length - 1) {
                State.currentQIndex++;
                AppController.renderFlashcard();
            } else {
                AppController.exitFlashcards();
                Utils.showToast(`Flashcard session complete! Total time: ${Utils.formatTime(State.sessionElapsedTime)}`, 'success');
            }
        },
        exitFlashcards: AppController.exitStudyMode,


        // --- Worksheet Mode Logic ---
        startWorksheet: () => { AppController.generateWorksheetContent(); },
        generateWorksheetContent: () => {
            let qContent = '<h3 style="color: var(--primary-light);">Practice Worksheet</h3><hr style="border-color: var(--bg-light);">';
            let aContent = '<h3 style="color: var(--secondary);">Answer Key</h3><hr style="border-color: var(--bg-light);">';
            
            State.sessionQuestions.forEach((q, index) => {
                const qNum = index + 1;
                const imageUrl = Utils.getImageUrl(q.imageId);
                
                qContent += `
                    <div class="worksheet-item" style="border-bottom: 1px dashed var(--bg-light); padding-bottom: 20px;">
                        <p><strong>${qNum}. ${q.q}</strong></p>
                        ${imageUrl ? `<img src="${imageUrl}" style="max-height: 100px; max-width: 80%; display: block; margin: 10px 0; border-radius: 4px; border: 1px solid var(--bg-light);">` : ''}
                        <div style="height: 35px; margin: 15px 0;"></div>
                        <ul style="list-style-type: none; padding-left: 0; font-size: 0.9em; color: var(--text-sub);">
                            ${q.opts.map(opt => `<li>[ ] ${opt}</li>`).join('')}
                        </ul>
                    </div>
                `;
                aContent += `
                    <div class="worksheet-item" style="border-bottom: 1px dashed var(--bg-light); padding-bottom: 10px;">
                        <p><strong>${qNum}. Answer: ${q.a}</strong></p>
                        <p style="font-size:0.9em; color:var(--text-sub); margin-top:-10px;"><em>Reason: ${q.why}</em></p>
                    </div>
                `;
            });
            
            UI.worksheetContent.innerHTML = qContent;
            document.getElementById('worksheet-answer-key-content').innerHTML = aContent;
            UI.worksheetAnswerKeyContainer.classList.add('hidden-print'); 
            UI.worksheetShowKeyBtn.innerText = "Show Answer Key";
        },
        toggleWorksheetAnswerKey: () => {
            const isHidden = UI.worksheetAnswerKeyContainer.classList.toggle('hidden-print');
            UI.worksheetShowKeyBtn.innerText = isHidden ? "Show Answer Key" : "Hide Answer Key";
        },
        printWorksheet: () => { window.print(); },
        closeWorksheet: AppController.exitStudyMode
    };

    // Global reference for inline HTML calls (like onclick)
    window.Controller = AppController; 

    // Initialize the application on load
    document.addEventListener('DOMContentLoaded', () => {
        AppController.loadState();
        AppController.initUI();
    });
</script>
</body>
</html>